{% extends 'base_main.html' %}
{% load static %}

{% block header_center_content %}
    {% if user.is_authenticated %}
        <div class="header-tabs">
            <a href="?tab=recommend" class="tab-item {% if tab == 'recommend' %}active{% endif %}">おすすめ</a>
            <a href="?tab=following" class="tab-item {% if tab == 'following' %}active{% endif %}">フォロー中</a>
        </div>
    {% endif %}
{% endblock %}

{% block header_right_content %}
    {% if user.is_authenticated %}
        <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="twitter-btn-outline">ログアウト</button>
        </form>
    {% else %}
        <a href="{% url 'account_login' %}" class="twitter-btn-outline">ログイン</a>
        <a href="{% url 'account_signup' %}" class="twitter-btn-primary">新規登録</a>
    {% endif %}
{% endblock %}

{% block main_content %}
    {% if user.is_authenticated %}
        <div class="post-form-area">
            <a href="{% url 'tweets:profile' user.username %}" class=user-avatar">
                <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
            </a>
            <div class="form-content">
                <textarea placeholder="いまどうしてる？" rows="2"></textarea>
                <div class="form-actions">
                    <i class="far fa-image image-icon"></i>
                    <button class="twitter-btn-primary post-btn">ツイートする</button>
                </div>
            </div>
        </div>

        <div class="tweet-list">
            {% for tweet in page_obj %}
                <div class="tweet-thread-container">
                    {% if tweet.reply %}
                        <div class="tweet-item parent-tweet">
                            <div class="user-avatar-container">
                                <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
                                <div class="thread-line"></div>
                            </div>
                            <div class="tweet-content">
                                {% if tweet.reply.retweet %}
                                    <div class="retweet-indicator">
                                        <i class="fas fa-retweet"></i>
                                        <span>
                                            {% if user == tweet.user %}
                                                あなた
                                            {% else %}
                                                {{ tweet.reply.user.display_name|default:tweet.reply.user.username }}
                                            {% endif %}
                                            がリツイートしました
                                        </span>
                                    </div>
                                {% endif %}

                                <div class="tweet-meta">
                                    {% with target=tweet.reply.retweet|default:tweet.reply %}
                                        <span class="display-name">
                                            {{ target.user.display_name|default:target.user.username }}
                                        </span>
                                        <span class="username">@{{ target.user.username }}</span>
                                        <span class="timestamp">· {{ target.formatted_date }}</span>
                                    {% endwith %}
                                </div>
                                <div class="tweet-text">
                                    {{ tweet.reply.retweet.content|default:tweet.reply.content|default:"（内容なし）" }}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="tweet-item main-tweet {% if tweet.reply %}is-reply{% endif %}">
                        <div class="user-avatar-container">
                            <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
                        </div>
                        <div class="tweet-content">
                            {% if tweet.retweet %}
                                <div class="retweet-indicator">
                                    <i class="fas fa-retweet"></i>
                                    <span>
                                        {% if user == tweet.user %}
                                            あなた
                                        {% else %}
                                            {{ tweet.user.display_name|default:tweet.user.username }}
                                        {% endif %}
                                        がリツイートしました
                                    </span>
                                </div>
                            {% endif %}

                            <div class="tweet-meta">
                                {% with target=tweet.retweet|default:tweet %}
                                    <span class="display-name">
                                        {{ target.user.display_name|default:target.user.username }}
                                    </span>
                                    <span class="username">@{{ target.user.username }}</span>
                                    <span class="timestamp">· {{ target.formatted_date }}</span>
                                {% endwith %}
                            </div>

                            {% if tweet.reply %}
                                <div class="replying-to">
                                    返信先:
                                    <a href="{% url 'tweets:profile' tweet.reply.user.username %}">
                                        @{{ tweet.reply.user.username }}
                                    </a>
                                </div>
                            {% endif %}

                            <div class="tweet-text">
                                {{ tweet.retweet.content|default:tweet.content }}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-timeline">
                    <h2>タイムラインへようこそ！</h2>
                    <p>いま起きていることを見つけたり、誰かをフォローして最新のツイートをチェックしましょう。</p>
                </div>
            {% endfor %}
        </div>

        {% if page_obj %}
            <nav class="home-pagination">
                <ul class="pagination">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?tab={{ tab }}&page={{ page_obj.previous_page_number }}">
                                ← 前のツイート
                            </a>
                        </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link active-page">{{ page_obj.number }}</span>
                    </li>
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?tab={{ tab }}&page={{ page_obj.next_page_number }}">
                                次のツイート →
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

    {% else %}
        <div class="welcome-section">
            <h2 class="welcome-title">Twitterクローンを使ってみよう</h2>
            <p class="welcome-text">今すぐ登録して、タイムラインをカスタマイズしましょう。</p>
            <a href="{% url 'account_signup' %}" class="twitter-btn-primary welcome-btn">アカウントを作成</a>
        </div>
    {% endif %}
{% endblock %}
{% block right_sidebar %}{% endblock %}